<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hospital — Request Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="hospital.css" />
  </head>
  <body>
    <h1>Hospital — Request Ambulance</h1>

    <div class="container">
      <div class="card form-area">
        <input id="hospitalId" placeholder="Hospital Name" />
        <ul id="hospitalSuggestions"></ul>

        <input id="patientName" placeholder="Patient Name" />
        <input
          id="pickupSearch"
          placeholder="Enter address or pincode"
          autocomplete="off"
        />
        <ul id="suggestions"></ul>

        <button id="useMyLocation">Use My Current Location</button>
        <button id="useTypedLocation">Use This Location</button>

        <select id="priority">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent</option>
          <option value="critical">Critical</option>
        </select>

        <textarea id="notes" placeholder="Extra Notes"></textarea>
        <button id="requestBtn">Request Ambulance</button>
        <button id="emergencyBtn" style="background:red;color:white;">
          🚨 Emergency Booking
        </button>
        <div id="statusArea" class="small">No requests yet.</div>
      </div>

      <div id="map"></div>
    </div>

    <script type="module">
      import { odishaHospitals } from "./hospitals.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // 🔹 Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const hospitalInput = document.getElementById("hospitalId");
      const hospitalSuggestions = document.getElementById(
        "hospitalSuggestions"
      );
      const patientNameInput = document.getElementById("patientName");
      const pickupSearchInput = document.getElementById("pickupSearch");
      const statusArea = document.getElementById("statusArea");
      let selectedCoords = null;
      let pickupMarker = null;
      let ambulanceMarker = null;
      let hospitalMarker = null;
      let selectedHospital = null;

      // 🚑 Custom Ambulance Icon
      const ambulanceIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3181/3181919.png",
        iconSize: [40, 40],
        iconAnchor: [20, 20],
        popupAnchor: [0, -20],
      });

      // 🏥 Custom Hospital Icon
      const hospitalIcon = L.icon({
        iconUrl:
          "https://cdn-icons-png.flaticon.com/512/3176/3176366.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -35],
      });

      let routeLine = null;

      // --- Map ---
      const map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      function safeUpdateMap(lat, lng, text, markerRef) {
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
          console.warn("⚠️ Skipping marker update — missing lat/lng");
          return markerRef;
        }
        if (markerRef) map.removeLayer(markerRef);
        map.setView([lat, lng], 15);
        return L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      }

      async function drawDrivingRoute(ambLat, ambLng, pickLat, pickLng) {
        const url = `https://router.project-osrm.org/route/v1/driving/${ambLng},${ambLat};${pickLng},${pickLat}?overview=full&geometries=geojson`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data.routes || data.routes.length === 0) return;

        const coords = data.routes[0].geometry.coordinates.map((c) => [
          c[1],
          c[0],
        ]);
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
      }

      // --- Reverse Geocoding ---
      async function reverseGeocode(lat, lon) {
        try {
          const resp = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
          );
          return await resp.json();
        } catch (err) {
          console.error("Error fetching address:", err);
          return null;
        }
      }

      // --- Address Search ---
      const suggestionsList = document.getElementById("suggestions");
      pickupSearchInput.addEventListener("input", async () => {
        const query = pickupSearchInput.value.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }
        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query
          )}&limit=5`
        );
        const data = await resp.json();
        suggestionsList.innerHTML = "";
        data.forEach((place) => {
          const li = document.createElement("li");
          li.textContent = place.display_name;
          li.onclick = () => {
            pickupSearchInput.value = place.display_name;
            selectedCoords = [parseFloat(place.lat), parseFloat(place.lon)];
            pickupMarker = safeUpdateMap(
              selectedCoords[0],
              selectedCoords[1],
              "Pickup Location",
              pickupMarker
            );
            suggestionsList.innerHTML = "";
          };
          suggestionsList.appendChild(li);
        });
      });

      // --- Current Location ---
      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition(
          async (pos) => {
            selectedCoords = [pos.coords.latitude, pos.coords.longitude];
            const data = await reverseGeocode(
              pos.coords.latitude,
              pos.coords.longitude
            );
            pickupSearchInput.value =
              data?.display_name || "Your Current Location";
            pickupMarker = safeUpdateMap(
              selectedCoords[0],
              selectedCoords[1],
              "Pickup Location",
              pickupMarker
            );
          },
          () => alert("Failed to get location. Enable GPS.")
        );
      };

      document.getElementById("useTypedLocation").onclick = () => {
        if (!selectedCoords) {
          alert("Select a location first!");
          return;
        }
        alert("Location confirmed: " + pickupSearchInput.value);
      };

      // --- Hospital Autocomplete ---
      hospitalInput.addEventListener("input", () => {
        const query = hospitalInput.value.toLowerCase().trim();
        hospitalSuggestions.innerHTML = "";
        if (!query) return;
        const matches = odishaHospitals.filter((h) =>
          (h?.name || "").toLowerCase().includes(query)
        );
        if (matches.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No hospitals found";
          hospitalSuggestions.appendChild(li);
          return;
        }
        matches.forEach((hospital) => {
          const li = document.createElement("li");
          li.textContent = hospital.name;
          li.onclick = () => {
            hospitalInput.value = hospital.name;
            hospitalSuggestions.innerHTML = "";
            selectedHospital = hospital;
          };
          hospitalSuggestions.appendChild(li);
        });
      });

      // --- Dummy Ambulance Data (replace with Firebase in future) ---
      const ambulances = [
        { id: "AMB1", driver: "Rajesh", plate: "OD-02-1234", lat: 20.30, lng: 85.82 },
        { id: "AMB2", driver: "Suresh", plate: "OD-05-5678", lat: 20.32, lng: 85.85 },
        { id: "AMB3", driver: "Anil", plate: "OD-10-9999", lat: 20.31, lng: 85.80 },
      ];

      function calcCost(lat1, lng1, lat2, lng2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a =
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) *
          Math.cos(lat2 * Math.PI / 180) *
          Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return (R * c * 10).toFixed(0); // cost = distance*10
      }

      function showAmbulances() {
        ambulances.forEach((amb) => {
          const cost = calcCost(
            selectedCoords[0],
            selectedCoords[1],
            selectedHospital.lat,
            selectedHospital.lng
          );
          const marker = L.marker([amb.lat, amb.lng], { icon: ambulanceIcon }).addTo(map);
          marker.bindPopup(
            `<b>🚑 Ambulance ${amb.plate}</b><br>Driver: ${amb.driver}<br>Cost: ₹${cost}<br>
            <button onclick="window.confirmBooking('${amb.id}')">Confirm Booking</button>`
          );
        });
      }

      // --- Confirm Booking (global function for popup buttons) ---
      window.confirmBooking = async (ambId) => {
        const amb = ambulances.find((a) => a.id === ambId);
        if (!amb) return;
        if (!confirm(`Confirm booking ambulance ${amb.plate}?`)) return;

        const requestRef = push(ref(db, "requests"));
        const requestData = {
          hospitalId: selectedHospital.name,
          patientName: patientNameInput.value.trim(),
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value.trim(),
          createdAt: serverTimestamp(),
          status: "requested",
          ambulanceId: amb.id,
          ambulancePlate: amb.plate,
          ambulanceDriver: amb.driver,
          ambulanceLat: amb.lat,
          ambulanceLng: amb.lng,
          hospitalLat: selectedHospital.lat,
          hospitalLng: selectedHospital.lng,
        };
        await set(requestRef, requestData);
        alert("✅ Ambulance booked successfully!");
      };

      // --- Request Button ---
      document.getElementById("requestBtn").onclick = () => {
        if (!selectedCoords || !selectedHospital) {
          alert("Please select hospital and location first!");
          return;
        }
        alert("Fetching nearby ambulances...");
        showAmbulances();
      };

      // --- Emergency Button ---
      document.getElementById("emergencyBtn").onclick = async () => {
        if (!selectedCoords || !selectedHospital) {
          alert("Please select hospital and location first!");
          return;
        }
        // pick cheapest ambulance
        let cheapest = null;
        let cheapestCost = Infinity;
        ambulances.forEach((amb) => {
          const cost = calcCost(
            selectedCoords[0],
            selectedCoords[1],
            selectedHospital.lat,
            selectedHospital.lng
          );
          if (cost < cheapestCost) {
            cheapest = amb;
            cheapestCost = cost;
          }
        });
        if (!cheapest) return;
        if (!confirm(`🚨 Emergency! Auto-book ${cheapest.plate} for ₹${cheapestCost}?`)) return;

        const requestRef = push(ref(db, "requests"));
        const requestData = {
          hospitalId: selectedHospital.name,
          patientName: patientNameInput.value.trim(),
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: "critical",
          notes: "Emergency auto booking",
          createdAt: serverTimestamp(),
          status: "requested",
          ambulanceId: cheapest.id,
          ambulancePlate: cheapest.plate,
          ambulanceDriver: cheapest.driver,
          ambulanceLat: cheapest.lat,
          ambulanceLng: cheapest.lng,
          hospitalLat: selectedHospital.lat,
          hospitalLng: selectedHospital.lng,
        };
        await set(requestRef, requestData);
        alert("🚑 Emergency ambulance booked!");
      };
    </script>
  </body>
</html>
