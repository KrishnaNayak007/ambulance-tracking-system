<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hospital â€” Request Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="hospitals.js"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
      body {
        font-family: system-ui;
        margin: 18px;
      }
      input,
      select,
      button,
      textarea {
        display: block;
        margin: 8px 0;
        padding: 8px;
        width: 100%;
        max-width: 480px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        max-width: 520px;
      }
      .small {
        font-size: 0.9rem;
        color: #555;
      }
      #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Hospital â€” Request Ambulance</h1>
    <div class="card">
      <input id="hospitalId"  placeholder="Hospital Name" />
      <ul
        id="hospitalSuggestions"
        style="max-width: 480px; list-style: none; padding: 0; margin: 0"
      ></ul>
      <input id="patientName" placeholder="Patient Name" />
      <input
        type="text"
        id="pickupSearch"
        placeholder="Enter address or pincode"
        autocomplete="off"
      />
      <ul
        id="suggestions"
        style="max-width: 480px; list-style: none; padding: 0; margin: 0"
      ></ul>

      <button id="useMyLocation">Use My Current Location</button>
      <button id="useTypedLocation">Use This Location</button>

      <select id="priority">
        <option value="normal">Normal</option>
        <option value="urgent">Urgent</option>
        <option value="critical">Critical</option>
      </select>

      <textarea id="notes" placeholder="Extra Notes"></textarea>
      <button id="requestBtn">Request Ambulance</button>
      <div id="statusArea" class="small">No requests yet.</div>
    </div>
    <div id="map"></div>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      const hospitalIdInput = document.getElementById("hospitalId");
      const patientNameInput = document.getElementById("patientName");
      const pickupSearchInput = document.getElementById("pickupSearch");
      const statusArea = document.getElementById("statusArea");
      let selectedCoords = null;

      // --- Map ---
      const map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);
      let pickupMarker = null;
      let ambulanceMarker = null;

      function updateMap(lat, lng, text, markerRef) {
        if (markerRef) map.removeLayer(markerRef);
        map.setView([lat, lng], 15);
        return L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      }

      // --- Search Suggestions ---
      const suggestionsList = document.getElementById("suggestions");
      pickupSearchInput.addEventListener("input", async function () {
        const query = pickupSearchInput.value.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }
        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query
          )}&limit=5`
        );
        const data = await resp.json();
        suggestionsList.innerHTML = "";
        data.forEach((place) => {
          const li = document.createElement("li");
          li.textContent = place.display_name;
          li.style.cursor = "pointer";
          li.onclick = () => {
            pickupSearchInput.value = place.display_name;
            selectedCoords = [parseFloat(place.lat), parseFloat(place.lon)];
            pickupMarker = updateMap(
              selectedCoords[0],
              selectedCoords[1],
              "Pickup Location",
              pickupMarker
            );
            suggestionsList.innerHTML = "";
          };
          suggestionsList.appendChild(li);
        });
      });

      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition((pos) => {
          selectedCoords = [pos.coords.latitude, pos.coords.longitude];
          pickupSearchInput.value = "Your Current Location";
          pickupMarker = updateMap(
            selectedCoords[0],
            selectedCoords[1],
            "Pickup Location",
            pickupMarker
          );
        });
      };
      document.getElementById("useTypedLocation").onclick = () => {
        if (!selectedCoords) {
          alert("Select a location first!");
          return;
        }
        alert("Location confirmed: " + pickupSearchInput.value);
      };

      // --- Request Ambulance ---
      document.getElementById("requestBtn").onclick = async () => {
        if (!selectedCoords) {
          alert("Select a location first!");
          return;
        }
        const hospitalId = hospitalIdInput.value.trim();
        const patientName = patientNameInput.value.trim();
        if (!hospitalId || !patientName) {
          alert("Enter hospital ID and patient name!");
          return;
        }

        const reqRef = db.ref("requests").push();
        const requestData = {
          hospitalId,
          patientName,
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value.trim(),
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          status: "requested",
          ambulanceId: null,
          ambulancePlate: null,
          ambulanceDriver: null,
        };
        await reqRef.set(requestData);
        statusArea.innerText = `Request created (ID: ${reqRef.key}). Waiting for ambulance...`;

        // Listen for acceptance
        reqRef.on("value", (snapshot) => {
          const updated = snapshot.val();
          if (!updated) return;
          if (updated.status === "Accepted") {
            alert(
              `ðŸš‘ Ambulance Accepted!\nPlate: ${updated.ambulancePlate}\nDriver: ${updated.ambulanceDriver}`
            );
            statusArea.innerText = `Ambulance assigned: ${updated.ambulancePlate}`;
            // Add ambulance marker
            ambulanceMarker = updateMap(
              updated.ambulanceLat,
              updated.ambulanceLng,
              `Ambulance: ${updated.ambulancePlate}`,
              ambulanceMarker
            );
            reqRef.off();
          }
        });
      };

      const hospitalInput = document.getElementById("hospitalId");
      const hospitalSuggestions = document.getElementById(
        "hospitalSuggestions"
      );

      hospitalInput.addEventListener("input", () => {
        const query = hospitalInput.value.toLowerCase().trim();
        hospitalSuggestions.innerHTML = "";

        if (!query) return;

        const matches = odishaHospitals.filter((h) =>
          h.toLowerCase().includes(query)
        );

        if (matches.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No hospitals found";
          hospitalSuggestions.appendChild(li);
          return;
        }

        matches.forEach((hospital) => {
          const li = document.createElement("li");
          li.textContent = hospital;
          li.style.cursor = "pointer";
          li.style.padding = "5px";
          li.style.borderBottom = "1px solid #eee";

          li.addEventListener("click", () => {
            hospitalInput.value = hospital;
            hospitalSuggestions.innerHTML = "";
          });

          hospitalSuggestions.appendChild(li);
        });
      });
    </script>
  </body>
</html>
