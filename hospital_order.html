<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hospital — Request Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="hospital.css" />
  </head>
  <body>
    <h1>Hospital — Request Ambulance</h1>

    <div class="container">
      <div class="card form-area">
        <input id="hospitalId" placeholder="Hospital Name" />
        <ul id="hospitalSuggestions"></ul>

        <input id="patientName" placeholder="Patient Name" />
        <input
          id="pickupSearch"
          placeholder="Enter address or pincode"
          autocomplete="off"
        />
        <ul id="suggestions"></ul>

        <button id="useMyLocation">Use My Current Location</button>
        <button id="useTypedLocation">Use This Location</button>

        <select id="priority">
          <option value="normal">Normal</option>
          <option value="urgent">Urgent</option>
          <option value="critical">Critical</option>
        </select>

        <textarea id="notes" placeholder="Extra Notes"></textarea>
        <button id="requestBtn">Request Ambulance</button>
        <div id="statusArea" class="small">No requests yet.</div>
      </div>

      <div id="map"></div>
    </div>

    <script type="module">
      import { odishaHospitals } from "./hospitals.js";
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // 🔹 Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const hospitalInput = document.getElementById("hospitalId");
      const hospitalSuggestions = document.getElementById(
        "hospitalSuggestions"
      );
      const patientNameInput = document.getElementById("patientName");
      const pickupSearchInput = document.getElementById("pickupSearch");
      const statusArea = document.getElementById("statusArea");
      let selectedCoords = null;
      let pickupMarker = null;
      let ambulanceMarker = null;
      let selectedHospital = null;

      // 🚑 Custom Ambulance Icon
      const ambulanceIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3181/3181919.png", // Ambulance icon
        iconSize: [40, 40], // size of the icon
        iconAnchor: [20, 20], // point of the icon which corresponds to marker's location
        popupAnchor: [0, -20], // popup position
      });

      let routeLine = null;

      // --- Map ---
      const map = L.map("map").setView([20.5937, 78.9629], 5);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      function safeUpdateMap(lat, lng, text, markerRef) {
        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
          console.warn("⚠️ Skipping marker update — missing lat/lng");
          return markerRef;
        }
        if (markerRef) map.removeLayer(markerRef);
        map.setView([lat, lng], 15);
        return L.marker([lat, lng]).addTo(map).bindPopup(text).openPopup();
      }

      async function drawDrivingRoute(ambLat, ambLng, pickLat, pickLng) {
        const url = `https://router.project-osrm.org/route/v1/driving/${ambLng},${ambLat};${pickLng},${pickLat}?overview=full&geometries=geojson`;

        const resp = await fetch(url);
        const data = await resp.json();

        if (!data.routes || data.routes.length === 0) return;

        const coords = data.routes[0].geometry.coordinates.map((c) => [
          c[1],
          c[0],
        ]);

        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);

        map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
      }

      // --- Reverse Geocoding (direct to Nominatim, no server needed) ---
      async function reverseGeocode(lat, lon) {
        try {
          const resp = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`
          );
          return await resp.json();
        } catch (err) {
          console.error("Error fetching address:", err);
          return null;
        }
      }

      // --- Pickup Search ---
      const suggestionsList = document.getElementById("suggestions");

      pickupSearchInput.addEventListener("input", async () => {
        const a = pickupSearchInput.value;
        const query = a.trim();
        if (query.length < 3) {
          suggestionsList.innerHTML = "";
          return;
        }

        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query
          )}&limit=5`
        );
        const data = await resp.json();
        suggestionsList.innerHTML = "";
        data.forEach((place) => {
          const li = document.createElement("li");
          li.textContent = place.display_name;
          li.onclick = () => {
            pickupSearchInput.value = place.display_name;
            selectedCoords = [parseFloat(place.lat), parseFloat(place.lon)];
            pickupMarker = safeUpdateMap(
              selectedCoords[0],
              selectedCoords[1],
              "Pickup Location",
              pickupMarker
            );
            suggestionsList.innerHTML = "";
          };
          suggestionsList.appendChild(li);
        });
      });

      // --- Current Location ---
      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          selectedCoords = [pos.coords.latitude, pos.coords.longitude];
          const data = await reverseGeocode(
            pos.coords.latitude,
            pos.coords.longitude
          );
          pickupSearchInput.value =
            data?.display_name || "Your Current Location";
          pickupMarker = safeUpdateMap(
            selectedCoords[0],
            selectedCoords[1],
            "Pickup Location",
            pickupMarker
          );
        });
      };

      document.getElementById("useTypedLocation").onclick = () => {
        if (!selectedCoords) {
          alert("Select a location first!");
          return;
        }
        alert("Location confirmed: " + pickupSearchInput.value);
      };

      // --- Hospital Autocomplete ---
      hospitalInput.addEventListener("input", () => {
        const query = hospitalInput.value.toLowerCase().trim();
        hospitalSuggestions.innerHTML = "";
        if (!query) return;

        const matches = odishaHospitals.filter((h) =>
          h.name.toLowerCase().includes(query)
        );
        if (matches.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No hospitals found";
          hospitalSuggestions.appendChild(li);
          return;
        }

        matches.forEach((hospital) => {
          const li = document.createElement("li");
          li.textContent = hospital.name;
          li.onclick = () => {
            hospitalInput.value = hospital.name;
            hospitalSuggestions.innerHTML = "";
            selectedHospital = hospital;
          };
          hospitalSuggestions.appendChild(li);
        });
      });

      // --- Request Ambulance ---
      document.getElementById("requestBtn").onclick = async () => {
        if (!selectedCoords) {
          alert("Select a location first!");
          return;
        }
        const hospitalId = hospitalInput.value.trim();
        const patientName = patientNameInput.value.trim();
        if (!hospitalId || !patientName) {
          alert("Enter hospital and patient name!");
          return;
        }

        // if (!selectedHospital) {
        //   selectedHospital = { name: hospitalId, lat: null, lng: null };
        // }

        const requestRef = push(ref(db, "requests"));
        const requestData = {
          hospitalId: selectedHospital.name,
          patientName,
          pickup: { lat: selectedCoords[0], lng: selectedCoords[1] },
          address: pickupSearchInput.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value.trim(),
          createdAt: serverTimestamp(),
          status: "requested",
          ambulanceId: null,
          ambulancePlate: null,
          ambulanceDriver: null,
          ambulanceLat: null,
          ambulanceLng: null,
          hospitalLat: selectedHospital.lat,
          hospitalLng: selectedHospital.lng,

          hospitalLat: selectedHospital?.lat || null,
          hospitalLng: selectedHospital?.lng || null,
        };

        await set(requestRef, requestData);

        statusArea.innerText = `Request created (ID: ${requestRef.key}). Waiting for ambulance...`;

        // Listen for updates (ambulance accepted)
        onValue(requestRef, (snapshot) => {
          const updated = snapshot.val();
          if (!updated) return;

          if (updated.status === "Accepted") {
            statusArea.innerText = `🚑 Ambulance assigned: ${updated.ambulancePlate} (${updated.ambulanceDriver})`;

            if (updated.ambulanceLat && updated.ambulanceLng) {
              // 🚑 Update ambulance marker
              if (ambulanceMarker) map.removeLayer(ambulanceMarker);
              ambulanceMarker = L.marker(
                [updated.ambulanceLat, updated.ambulanceLng],
                { icon: ambulanceIcon }
              )
                .addTo(map)
                .bindPopup(`🚑 Ambulance: ${updated.ambulancePlate}`)
                .openPopup();

              // 🛣 Draw live route ambulance → pickup
              if (updated.pickup?.lat && updated.pickup?.lng) {
                drawDrivingRoute(
                  updated.ambulanceLat,
                  updated.ambulanceLng,
                  updated.pickup.lat,
                  updated.pickup.lng
                );

                // 🎯 Fit map to both ambulance & pickup like Ola/Uber
                const bounds = L.latLngBounds([
                  [updated.ambulanceLat, updated.ambulanceLng],
                  [updated.pickup.lat, updated.pickup.lng],
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
              }
            }
          } else if (updated.status === "PickedUp") {
            statusArea.innerText =
              "🚑 Patient picked up, heading to hospital...";

            if (
              updated.ambulanceLat &&
              updated.ambulanceLng &&
              updated.hospitalLat &&
              updated.hospitalLng
            ) {
              if (ambulanceMarker) map.removeLayer(ambulanceMarker);
              ambulanceMarker = L.marker(
                [updated.ambulanceLat, updated.ambulanceLng],
                { icon: ambulanceIcon }
              )
                .addTo(map)
                .bindPopup(`🚑 Ambulance: ${updated.ambulancePlate}`)
                .openPopup();

              // 🛣 Draw live route ambulance → hospital
              drawDrivingRoute(
                updated.ambulanceLat,
                updated.ambulanceLng,
                updated.hospitalLat,
                updated.hospitalLng
              );

              // 🎯 Fit map to ambulance & hospital
              const bounds = L.latLngBounds([
                [updated.ambulanceLat, updated.ambulanceLng],
                [updated.hospitalLat, updated.hospitalLng],
              ]);
              map.fitBounds(bounds, { padding: [50, 50] });
            }
          }
        });////
      };
    </script>
  </body>
</html>
