<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hospital — Order Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
      body {
        font-family: system-ui;
        margin: 18px;
      }
      input,
      select,
      button,
      textarea {
        display: block;
        margin: 8px 0;
        padding: 8px;
        width: 100%;
        max-width: 480px;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        border-radius: 8px;
        max-width: 520px;
      }
      .small {
        font-size: 0.9rem;
        color: #555;
      }
      #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
      }
    </style>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <h1>Hospital — Request Ambulance</h1>

    <div class="card">
      <input id="hospitalId" value="hospital_01" placeholder="Hospital ID" />
      <input id="patientName" placeholder="Patient Name" />

      <input
        type="text"
        id="pickupSearch"
        placeholder="Enter address or pincode"
        autocomplete="off"
      />
      <ul
        id="suggestions"
        style="max-width: 480px; list-style: none; padding: 0; margin: 0"
      ></ul>

      <button id="useMyLocation">Use My Current Location</button>
      <button id="useTypedLocation">Use This Location</button>

      <select id="priority">
        <option value="normal">Normal</option>
        <option value="urgent">Urgent</option>
        <option value="critical">Critical</option>
      </select>

      <textarea id="notes" placeholder="Extra Notes"></textarea>
      <button id="requestBtn">Request Ambulance</button>
      <div id="statusArea" class="small">No requests yet.</div>
    </div>

    <div id="map"></div>

    <script>
      const statusArea = document.getElementById("statusArea");

      // Firebase config (fill with your credentials)
      const firebaseConfig = {
        apiKey: "FIREBASE_API_KEY",
        authDomain: "PROJECT.firebaseapp.com",
        databaseURL: "https://PROJECT.firebaseio.com",
        projectId: "PROJECT",
        storageBucket: "PROJECT.appspot.com",
        messagingSenderId: "SENDER_ID",
        appId: "APP_ID",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Leaflet map
      var map = L.map("map").setView([20.5937, 78.9629], 5); // India default
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      }).addTo(map);

      let selectedCoords = null;

      
      const pickupSearch = document.getElementById("pickupSearch");
      const suggestions = document.getElementById("suggestions");

      pickupSearch.addEventListener("input", async function () {
        const query = pickupSearch.value.trim();
        if (query.length < 3) {
          suggestions.innerHTML = "";
          return;
        }
        const resp = await fetch(
          `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`
        );
        const data = await resp.json();
        suggestions.innerHTML = "";
        data.features.forEach((feature) => {
          const li = document.createElement("li");
          li.textContent =
            feature.properties.name +
            ", " +
            (feature.properties.city || "") +
            ", " +
            (feature.properties.country || "");
          li.style.cursor = "pointer";
          li.onclick = () => {
            pickupSearch.value = li.textContent;
            selectedCoords = feature.geometry.coordinates; // [lng, lat]
            map.setView([selectedCoords[1], selectedCoords[0]], 15);
            if (window.manualMarker) map.removeLayer(window.manualMarker);
            window.manualMarker = L.marker([
              selectedCoords[1],
              selectedCoords[0],
            ])
              .addTo(map)
              .bindPopup("Selected Location")
              .openPopup();
            suggestions.innerHTML = "";
          };
          suggestions.appendChild(li);
        });
      });
      //Use My Location
      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          selectedCoords = [pos.coords.longitude, pos.coords.latitude];
          // Fetch address using Photon reverse geocoding
          const resp = await fetch(
            `https://photon.komoot.io/reverse?lat=${selectedCoords[1]}&lon=${selectedCoords[0]}`
          );
          const data = await resp.json();
          const address =
            data.features && data.features[0]
              ? data.features[0].properties.name +
                ", " +
                (data.features[0].properties.city || "") +
                ", " +
                (data.features[0].properties.country || "")
              : "";
          pickupSearch.value = address;

          map.setView([pos.coords.latitude, pos.coords.longitude], 15);

          if (window.manualMarker) map.removeLayer(window.manualMarker);
          window.manualMarker = L.marker([
            pos.coords.latitude,
            pos.coords.longitude,
          ])
            .addTo(map)
            .bindPopup("Your Location")
            .openPopup();
        });
      };

      //Use Typed Location (from search box)
      document.getElementById("useTypedLocation").onclick = () => {
        if (!selectedCoords) {
          alert("Please search for a location first!");
          return;
        }
        statusArea.innerText =
          "Using manually selected location: " +
          pickupSearch.value;
      };

      //Request Ambulance
      document.getElementById("requestBtn").onclick = async () => {
        if (!selectedCoords) {
          alert("Please select a location first!");
          return;
        }

        const hospitalId = document.getElementById("hospitalId").value;
        const patientName = document.getElementById("patientName").value;
        if (!hospitalId || !patientName) {
          alert("Please enter patient name and hospital ID.");
          return;
        }

        const req = {
          hospitalId: document.getElementById("hospitalId").value,
          patientName: document.getElementById("patientName").value,
          pickup: {
            lat: selectedCoords[1],
            lng: selectedCoords[0],
          },
          address: pickupSearch.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value,
          createdAt: Date.now(),
          status: "requested",
          ambulanceId: null,
        };

        const ref = db.ref("requests").push();
        await ref.set(req);
        statusArea.innerText = `Request created (id: ${ref.key}). Waiting for assignment...`;
      };

      window.onload = function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 13);
          });
        }
      };
    </script>
  </body>
</html>
