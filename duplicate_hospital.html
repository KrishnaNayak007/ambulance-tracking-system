<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Hospital ‚Äî Order Ambulance</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <link rel="stylesheet" href="style.css" />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  </head>
  <body>
    <div class="header-row">
      <a class="btn home-link" href="index.html">‚Üê Home</a>

      <h1 class="title">
        <span class="icon">üè•</span>
        <span class="text">HOSPITAL</span> ‚Äî
        <span class="icon">üöë</span>
        <span class="text">REQUEST AMBULANCE</span>
      </h1>
    </div>

    <div class="container">
      <div class="form-area">
        <div class="card">
          <input id="hospitalId" value="hospital_01" placeholder="Hospital ID" />
          <input id="patientName" placeholder="Patient Name" />

          <input
            type="text"
            id="pickupSearch"
            placeholder="Enter address or pincode"
            autocomplete="off"
          />
          <ul
            id="suggestions"
            style="max-width: 480px; list-style: none; padding: 0; margin: 0"
          ></ul>

          <button id="useMyLocation">Use My Current Location</button>
          <button id="useTypedLocation">Use This Location</button>

          <select id="priority">
            <option value="normal">Normal</option>
            <option value="urgent">Urgent</option>
            <option value="critical">Critical</option>
          </select>

          <textarea id="notes" placeholder="Extra Notes"></textarea>
          <button id="requestBtn">Request Ambulance</button>
          <div id="statusArea" class="small">No requests yet.</div>
        </div>
      </div>

      <div id="map"></div>
    </div>

    <!-- ‚úÖ Modal -->
    <div id="requestModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Request Submitted!</h2>
        <p>Your ambulance request has been sent successfully. üöë</p>
      </div>
    </div>

    <script>
      const statusArea = document.getElementById("statusArea");

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
        measurementId: "G-0PM28YF030",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // Leaflet map
      var map = L.map("map").setView([20.5937, 78.9629], 5); // India default
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>',
      }).addTo(map);

      let selectedCoords = null;
      let ambulanceMarker = null;

      const pickupSearch = document.getElementById("pickupSearch");
      const suggestions = document.getElementById("suggestions");

      // üîç Location search
      pickupSearch.addEventListener("input", async function () {
        const query = pickupSearch.value.trim();
        if (query.length < 3) {
          suggestions.innerHTML = "";
          return;
        }
        const resp = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(
            query
          )}&addressdetails=1&limit=5`
        );
        const data = await resp.json();
        suggestions.innerHTML = "";
        data.forEach((place) => {
          const li = document.createElement("li");
          li.textContent = place.display_name;
          li.style.cursor = "pointer";
          li.onclick = () => {
            pickupSearch.value = place.display_name;
            selectedCoords = [place.lon, place.lat];
            map.setView([selectedCoords[1], selectedCoords[0]], 15);
            if (window.manualMarker) map.removeLayer(window.manualMarker);
            window.manualMarker = L.marker([
              selectedCoords[1],
              selectedCoords[0],
            ])
              .addTo(map)
              .bindPopup("Selected Location")
              .openPopup();
            suggestions.innerHTML = "";
          };
          suggestions.appendChild(li);
        });
      });

      // üìç Use My Location
      document.getElementById("useMyLocation").onclick = () => {
        navigator.geolocation.getCurrentPosition(async (pos) => {
          selectedCoords = [pos.coords.longitude, pos.coords.latitude];
          const resp = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${selectedCoords[1]}&lon=${selectedCoords[0]}&addressdetails=1`
          );
          const data = await resp.json();
          pickupSearch.value =
            data?.display_name || "Unknown Location, India";

          map.setView([pos.coords.latitude, pos.coords.longitude], 15);
          if (window.manualMarker) map.removeLayer(window.manualMarker);
          window.manualMarker = L.marker([
            pos.coords.latitude,
            pos.coords.longitude,
          ])
            .addTo(map)
            .bindPopup("Your Location")
            .openPopup();
        });
      };

      // üìç Use Typed Location
      document.getElementById("useTypedLocation").onclick = () => {
        if (!selectedCoords) {
          alert("Please search for a location first!");
          return;
        }
        statusArea.innerText =
          "Using manually selected location: " + pickupSearch.value;
      };

      // üöë Request Ambulance
      const modal = document.getElementById("requestModal");
      const closeBtn = document.querySelector(".close");

      document.getElementById("requestBtn").onclick = async () => {
        if (!selectedCoords || selectedCoords.length < 2) {
          alert("Please select a location first!");
          return;
        }

        const hospitalId = document.getElementById("hospitalId").value;
        const patientName = document.getElementById("patientName").value;
        if (!hospitalId || !patientName) {
          alert("Please enter patient name and hospital ID.");
          return;
        }

        const req = {
          hospitalId,
          patientName,
          pickup: {
            lat: selectedCoords[1],
            lng: selectedCoords[0],
          },
          address: pickupSearch.value,
          priority: document.getElementById("priority").value,
          notes: document.getElementById("notes").value,
          createdAt: Date.now(),
          status: "requested",
          ambulanceId: null,
        };

        const ref = db.ref("requests").push();
        await ref.set(req);
        statusArea.innerText = `Request created (id: ${ref.key}). Waiting for assignment...`;

        // ‚úÖ Show modal
        modal.style.display = "flex";
      };

      // ‚ùå Close modal
      closeBtn.onclick = () => {
        modal.style.display = "none";
      };
      window.onclick = (event) => {
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };

      // üåç Center map on user load
      window.onload = function () {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            map.setView([pos.coords.latitude, pos.coords.longitude], 13);
          });
        }
      };
    </script>
  </body>
</html>
