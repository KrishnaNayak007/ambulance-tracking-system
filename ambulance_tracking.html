<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ambulance Tracking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="hospitals.js"></script>

<style>
body { margin:0; font-family:system-ui; }
#map { height:100vh; width:100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ambulance info
let currentHospital = "null";
const ambulancePlate = "null";
const ambulanceDriver = "null";

const driverPlate = localStorage.getItem("driverPlate");
if (!driverPlate) {
  alert("Please register first!");
  window.location.href = "driver_register.html";
} else {
  firebase.database().ref("drivers/" + driverPlate).once("value", snap => {
    const data = snap.val();
    if (!data) {
      alert("Driver not found! Please register again.");
      window.location.href = "driver_register.html";
    } else {
      ambulancePlate = data.ambulancePlate;
      ambulanceDriver = data.driverName;
      currentHospital = data.hospital;
      alert(`ðŸš‘ Welcome ${ambulanceDriver} (${ambulancePlate})\nHospital: ${currentHospital}`);
    }
  });
}

const map = L.map("map").setView([20.5937,78.9629],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"&copy; OpenStreetMap contributors"
}).addTo(map);

let ambulanceMarker = null;
const alertedRequests = new Set();
const pageLoadTime = Date.now();

// Accept request
function acceptRequest(id, lat, lng) {
  navigator.geolocation.getCurrentPosition(pos=>{
    db.ref("requests/"+id).update({
      status:"Accepted",
      ambulanceId:ambulancePlate,
      ambulancePlate:ambulancePlate,
      ambulanceDriver:ambulanceDriver,
      ambulanceLat:pos.coords.latitude,
      ambulanceLng:pos.coords.longitude
    });
    alert("ðŸš‘ You accepted the request!");
    startLiveTracking(id);
  });
}

// Live tracking
function startLiveTracking(id){
  setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      db.ref("requests/"+id).update({
        ambulanceLat: lat,
        ambulanceLng: lng,
        status:"En Route"
      });
      if(!ambulanceMarker){
        ambulanceMarker = L.marker([lat,lng],{icon:L.divIcon({html:"ðŸš‘", iconSize:[24,24]})}).addTo(map);
      } else {
        ambulanceMarker.setLatLng([lat,lng]);
      }
      map.setView([lat,lng],15);
    });
  },5000);
}

// Listen for new requests
db.ref("requests").on("child_added", snapshot=>{
  const req = snapshot.val();
  const id = snapshot.key;

  if(!req) return;
  if (!currentHospital || req.hospitalId !== currentHospital) return;

  // Skip already alerted
  if(alertedRequests.has(id)) return;
  // Skip old requests
  if(req.createdAt && req.createdAt < pageLoadTime) return;

  alertedRequests.add(id);

  alert(`ðŸš¨ New Request!\nPatient: ${req.patientName}\nPriority: ${req.priority}`);

  if(req.pickup?.lat && req.pickup?.lng){
    map.setView([req.pickup.lat, req.pickup.lng],15);
    L.marker([req.pickup.lat, req.pickup.lng],{
      icon:L.divIcon({html:"ðŸ“", iconSize:[24,24]})
    }).addTo(map).bindPopup(
      `<b>Patient:</b> ${req.patientName}<br>
      <button onclick="acceptRequest('${id}',${req.pickup.lat},${req.pickup.lng})">Accept</button>`
    ).openPopup();
  }
});

// Example: when driver presses "Drop at Hospital" button
function completeTrip(requestId) {
  const requestRef = ref(db, "requests/" + requestId);

  // Remove the request completely
  remove(requestRef)
    .then(() => {
      alert("Trip completed and request removed from database.");
    })
    .catch((error) => {
      console.error("Error removing request:", error);
    });
}

</script>
</body>
</html>
