<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ambulance Tracking</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { margin:0; font-family:system-ui; }
#map { height:100vh; width:100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
  authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
  databaseURL: "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "ambulance-tracking-syste-21793",
  storageBucket: "ambulance-tracking-syste-21793.appspot.com",
  messagingSenderId: "1057546446784",
  appId: "1:1057546446784:web:9d31ba29b95928346fca25"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ambulance info
const currentHospital = "Hospital Name"; // match the hospitalId in request
const ambulancePlate = "AM001";
const ambulanceDriver = "Rajesh Kumar";

const map = L.map("map").setView([20.5937,78.9629],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"&copy; OpenStreetMap contributors" }).addTo(map);

let ambulanceMarker = null;
const pickupMarkers = {};
const alertedRequests = new Set();
const pageLoadTime = Date.now();

// Accept request and start live tracking
function acceptRequest(requestId, pickupLat, pickupLng) {
  navigator.geolocation.getCurrentPosition(pos => {
    db.ref("requests/"+requestId).update({
      status:"Accepted",
      ambulanceId:ambulancePlate,
      ambulancePlate:ambulancePlate,
      ambulanceDriver:ambulanceDriver,
      ambulanceLat:pos.coords.latitude,
      ambulanceLng:pos.coords.longitude
    });
    alert("🚑 You accepted the request!");
    startLiveTracking(requestId);
  });
}

// Live tracking of ambulance
function startLiveTracking(requestId) {
  setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      db.ref("requests/"+requestId).update({
        ambulanceLat: lat,
        ambulanceLng: lng,
        status: "En Route"
      });
      if(!ambulanceMarker){
        ambulanceMarker=L.marker([lat,lng],{icon:L.divIcon({html:"🚑", iconSize:[24,24]})}).addTo(map);
      }else{
        ambulanceMarker.setLatLng([lat,lng]);
      }
      map.setView([lat,lng],15);
    });
  },5000);
}

// Listen for new requests
db.ref("requests").on("child_added", snapshot => {
  const req = snapshot.val();
  const id = snapshot.key;
  if (!req || req.hospitalId !== currentHospital) return;
  if (alertedRequests.has(id)) return;
  if (req.createdAt && req.createdAt < pageLoadTime) return; // only new requests

  alertedRequests.add(id);
  alert(`🚨 New Request!\nPatient: ${req.patientName}\nPriority: ${req.priority}`);

  // Add pickup marker
  if (req.pickup?.lat && req.pickup?.lng) {
    if (pickupMarkers[id]) map.removeLayer(pickupMarkers[id]);
    const marker = L.marker([req.pickup.lat, req.pickup.lng], {
      icon: L.divIcon({ html: "📍", iconSize: [24, 24] }),
    })
      .addTo(map)
      .bindPopup(
        `<b>Patient:</b> ${req.patientName}<br><button onclick="acceptRequest('${id}',${req.pickup.lat},${req.pickup.lng})">Accept Request</button>`
      )
      .openPopup();

    pickupMarkers[id] = marker;

    // Zoom and center map on pickup location
    map.setView([req.pickup.lat, req.pickup.lng], 15);
  }
});

</script>
</body>
</html>
