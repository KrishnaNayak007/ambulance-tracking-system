<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ðŸš‘ Ambulance Tracking</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        font-family: system-ui;
        margin: 0;
      }
      #map {
        height: 70vh;
      }
      #info {
        padding: 10px;
        background: #f3f4f6;
      }
      button {
        padding: 8px 12px;
        margin-top: 10px;
        cursor: pointer;
      }
      #popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #popupBox {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }
      #popupBox h3 {
        margin: 0 0 10px;
      }
      #popupBox button {
        margin: 5px;
      }
      #rejectBtn {
        background: #dc2626;
        color: #fff;
        border: none;
      }
      #acceptBtn {
        background: #16a34a;
        color: #fff;
        border: none;
      }
    </style>
  </head>
  <body>
    <h2 style="padding: 10px">ðŸš‘ Ambulance Tracking</h2>
    <div id="map"></div>
    <div id="info">No active requests.</div>

    <div id="popup">
      <div id="popupBox">
        <h3>ðŸš¨ New Request</h3>
        <p id="popupText"></p>
        <button id="acceptBtn">Accept</button>
        <button id="rejectBtn">Reject</button>
      </div>
    </div>

    <button id="pickupBtn" class="btn btn-primary">âœ… Patient Picked Up</button>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCVOmAoo9h2-VJ6I7OCK2Naj2fYQq_Io1s",
        authDomain: "ambulance-tracking-syste-21793.firebaseapp.com",
        databaseURL:
          "https://ambulance-tracking-syste-21793-default-rtdb.asia-southeast1.firebasedatabase.app/",
        projectId: "ambulance-tracking-syste-21793",
        storageBucket: "ambulance-tracking-syste-21793.appspot.com",
        messagingSenderId: "1057546446784",
        appId: "1:1057546446784:web:549e7f233fdd29786fca25",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let routeLine = null;
      const driverIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/3181/3181919.png",
        iconSize: [40, 40],
        iconAnchor: [20, 20],
      });
      const hospitalIcon = L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/2967/2967355.png",
        iconSize: [40, 40],
        iconAnchor: [20, 40],
      });

      let driverMarker = null;
      let hospitalMarker = null;

      const map = L.map("map").setView([20.2961, 85.8245], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
      }).addTo(map);

      async function drawDrivingRoute(startLat, startLng, endLat, endLng) {
        const url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
        const resp = await fetch(url);
        const data = await resp.json();
        if (!data.routes || data.routes.length === 0) return;
        const coords = data.routes[0].geometry.coordinates.map((c) => [
          c[1],
          c[0],
        ]);
        if (routeLine) map.removeLayer(routeLine);
        routeLine = L.polyline(coords, { color: "blue", weight: 5 }).addTo(map);
        map.fitBounds(routeLine.getBounds(), { padding: [30, 30] });
      }

      const infoDiv = document.getElementById("info");
      let activeRequestId = null;

      const popup = document.getElementById("popup");
      const popupText = document.getElementById("popupText");
      const acceptBtn = document.getElementById("acceptBtn");
      const rejectBtn = document.getElementById("rejectBtn");

      const driverPlate = localStorage.getItem("driverPlate") || "TEST123";
      const driverName = localStorage.getItem("driverName") || "Test Driver";

      // --- continuous ambulance location update in DB ---
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          (pos) => {
            const ambLat = pos.coords.latitude;
            const ambLng = pos.coords.longitude;
            update(ref(db, "ambulances/" + driverPlate), {
              driver: driverName,
              plate: driverPlate,
              lat: ambLat,
              lng: ambLng,
              status: activeRequestId ? "busy" : "available",
              lastUpdated: new Date().toISOString(),
            });
          },
          (err) => console.error("Location error:", err),
          { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
        );
      }

      const requestsRef = ref(db, "requests");
      onValue(requestsRef, (snapshot) => {
        snapshot.forEach((child) => {
          const requestId = child.key;
          const req = child.val();

          if (req.status === "requested" && !activeRequestId) {
            popupText.innerHTML = `
              Patient: ${req.patientName || "-"}<br>
              Hospital: ${req.hospitalId || "-"}<br>
              Priority: ${req.priority || "normal"}
            `;
            popup.style.display = "flex";

            acceptBtn.onclick = () => {
              popup.style.display = "none";
              activeRequestId = requestId;

              onValue(ref(db, "requests/" + activeRequestId), (snap) => {
                const currentReq = snap.val();
                if (!currentReq) return;

                if (driverMarker) {
                  driverMarker.setLatLng([
                    currentReq.ambulanceLat,
                    currentReq.ambulanceLng,
                  ]);
                }

                if (
                  currentReq.status === "PickedUp" &&
                  currentReq.hospitalLat &&
                  currentReq.hospitalLng
                ) {
                  drawDrivingRoute(
                    currentReq.ambulanceLat,
                    currentReq.ambulanceLng,
                    currentReq.hospitalLat,
                    currentReq.hospitalLng
                  );

                  if (hospitalMarker) map.removeLayer(hospitalMarker);
                  hospitalMarker = L.marker(
                    [currentReq.hospitalLat, currentReq.hospitalLng],
                    { icon: hospitalIcon }
                  )
                    .addTo(map)
                    .bindPopup("ðŸ¥ Hospital Destination")
                    .openPopup();
                }
              });

              update(ref(db, "requests/" + requestId), {
                status: "Accepted",
                ambulancePlate: driverPlate,
                ambulanceDriver: driverName,
              });

              navigator.geolocation.getCurrentPosition((pos) => {
                const ambLat = pos.coords.latitude;
                const ambLng = pos.coords.longitude;

                update(ref(db, "requests/" + requestId), {
                  ambulanceLat: ambLat,
                  ambulanceLng: ambLng,
                });

                if (driverMarker) map.removeLayer(driverMarker);
                driverMarker = L.marker([ambLat, ambLng], { icon: driverIcon })
                  .addTo(map)
                  .bindPopup("ðŸš‘ You are here")
                  .openPopup();

                drawDrivingRoute(
                  ambLat,
                  ambLng,
                  req.pickup.lat,
                  req.pickup.lng
                );
              });

              navigator.geolocation.watchPosition((pos) => {
                const ambLat = pos.coords.latitude;
                const ambLng = pos.coords.longitude;
                update(ref(db, "requests/" + activeRequestId), {
                  ambulanceLat: ambLat,
                  ambulanceLng: ambLng,
                });

                if (driverMarker) {
                  driverMarker.setLatLng([ambLat, ambLng]);
                } else {
                  driverMarker = L.marker([ambLat, ambLng], {
                    icon: driverIcon,
                  })
                    .addTo(map)
                    .bindPopup("ðŸš‘ You are here")
                    .openPopup();
                }
              });

              infoDiv.innerHTML = `
                <b>Active Request:</b><br>
                Patient: ${req.patientName}<br>
                Hospital: ${req.hospitalId}<br>
                Priority: ${req.priority}<br>
                <button id="completeBtn">âœ… Complete Trip</button>
              `;

              document.getElementById("completeBtn").onclick = async () => {
                if (!activeRequestId) return;
                await update(ref(db, "requests/" + activeRequestId), {
                  status: "Completed",
                  completedAt: new Date().toISOString(),
                });
                await update(ref(db, "ambulances/" + driverPlate), {
                  status: "available",
                });
                alert("âœ… Trip completed!");
                infoDiv.innerHTML = "Trip marked as completed.";

                // ðŸ”¹ Remove hospital marker
                if (hospitalMarker) {
                  map.removeLayer(hospitalMarker);
                  hospitalMarker = null;
                }

                // ðŸ”¹ Remove polyline route
                if (routeLine) {
                  map.removeLayer(routeLine);
                  routeLine = null;
                }

                activeRequestId = null;
              };
            };

            rejectBtn.onclick = () => {
              popup.style.display = "none";
              console.log("Request ignored by driver");
            };
          }
        });
      });

      document.getElementById("pickupBtn").onclick = async () => {
        if (!activeRequestId) return;
        await update(ref(db, "requests/" + activeRequestId), {
          status: "PickedUp",
        });
        alert("ðŸš‘ Patient picked up, heading to hospital!");
      };
    </script>
  </body>
</html>
